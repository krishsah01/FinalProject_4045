<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoomieRadar | Calendar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <style>
        .calendar {
            max-width: 900px;
            margin: 0 auto;
        }

        .calendar .day {
            min-height: 110px;
            padding: .5rem;
            border: 1px solid #e9ecef;
            background: #fff;
        }

        .calendar .day.out-of-month {
            background: #f8f9fa;
            color: #6c757d;
        }

        .calendar .day .date-num {
            font-weight: 600;
        }

        .calendar .item-badge {
            display: block;
            margin-top: .35rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .calendar .day .more {
            margin-top: .25rem;
            font-size: .85rem;
        }
    </style>
</head>

<body class="bg-light d-flex flex-column min-vh-100">

    <header class="bg-primary text-white text-center py-4 shadow-sm">
        <h1 class="fs-3 mb-1 fw-bold">RoomieRadar</h1>
        <p class="mb-0 small opacity-90">Shared Calendar</p>
    </header>

    <main class="container flex-grow-1 mt-4 calendar">
        <div th:if="${noHousehold}" class="alert alert-warning d-flex align-items-center justify-content-center">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            Join or create a household to view shared calendar items.
        </div>

        <div th:if="${noHousehold}" class="text-muted text-center py-5">
            <i class="bi bi-calendar-x display-1 text-secondary opacity-25"></i>
            <p class="mt-3">Calendar hidden until household membership exists.</p>
        </div>

        <div th:unless="${noHousehold}">
            <div class="d-flex align-items-center mb-3">
                <div>
                    <button id="prevBtn" class="btn btn-outline-primary btn-sm">&larr;</button>
                    <button id="nextBtn" class="btn btn-outline-primary btn-sm ms-1">&rarr;</button>
                </div>
                <h2 id="monthLabel" class="flex-grow-1 text-center mb-0"></h2>
                <div>
                    <a th:href="@{/calendar/new}" class="btn btn-primary btn-sm">New item</a>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center">Sun</th>
                            <th class="text-center">Mon</th>
                            <th class="text-center">Tue</th>
                            <th class="text-center">Wed</th>
                            <th class="text-center">Thu</th>
                            <th class="text-center">Fri</th>
                            <th class="text-center">Sat</th>
                        </tr>
                    </thead>
                    <tbody id="calendarBody"></tbody>
                </table>
            </div>

            <div class="mt-3 text-center text-muted small">
                Items shown are the household's events and calendar items.
            </div>
        </div>
    </main>

    <!-- Hidden server-rendered data: expects model attributes 'events' and 'calendarItems' -->
    <div id="serverData" style="display:none;" th:unless="${noHousehold}">
        <div th:each="e : ${events}" th:attr="data-id=${e.id},
              data-title=${e.name},
              data-start=${e.eventDate != null ? #temporals.format(e.eventDate, 'yyyy-MM-dd''T''HH:mm') : ''},
              data-end=${''},
              data-allDay=${false},
              data-kind='event'"></div>

        <!-- calendar item instances: one div per date-instance (data-start = yyyy-MM-dd) -->
        <div th:each="entry : ${calendarItemInstances.entrySet()}">
            <div th:each="inst : ${entry.value}" th:attr="data-id=${inst.item.id},
                  data-title=${inst.item.name},
                  data-start=${inst.date != null ? #temporals.format(inst.date, 'yyyy-MM-dd') : ''},
                  data-end=${''},
                  data-allDay=${false},
                  data-kind='calendar'"></div>
        </div>
    </div>

    <nav class="navbar fixed-bottom navbar-bottom shadow-lg">
        <div class="container d-flex justify-content-around">
            <a th:href="@{/}" class="nav-link" title="Home">
                <i class="bi bi-house-door-fill fs-4"></i>
                <span class="d-none d-sm-inline ms-1">Home</span>
            </a>
            <a th:href="@{/bills}" class="nav-link" title="Bills">
                <i class="bi bi-cash-stack fs-4"></i>
                <span class="d-none d-sm-inline ms-1">Bills</span>
            </a>
            <a th:href="@{/chores}" class="nav-link" title="Chores">
                <i class="bi bi-broom fs-4"></i>
                <span class="d-none d-sm-inline ms-1">Chores</span>
            </a>
            <a th:href="@{/events}" class="nav-link" title="Events">
                <i class="bi bi-calendar-event fs-4"></i>
                <span class="d-none d-sm-inline ms-1">Events</span>
            </a>
            <a th:href="@{/calendar}" class="nav-link active" title="Calendar">
                <i class="bi bi-calendar-week fs-4"></i>
                <span class="d-none d-sm-inline ms-1">Calendar</span>
            </a>
            <a th:href="@{/household}" class="nav-link" title="Household">
                <i class="bi bi-people-fill fs-4"></i>
                <span class="d-none d-sm-inline ms-1">People</span>
            </a>
            <form id="logoutForm" th:action="@{/logout}" method="post" style="display: none;"></form>
            <a href="#" onclick="document.getElementById('logoutForm').submit(); return false;"
                class="nav-link text-danger" title="Logout">
                <i class="bi bi-box-arrow-right fs-4"></i>
                <span class="d-none d-sm-inline ms-1">Logout</span>
            </a>
        </div>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/script.js}"></script>
    <script th:unless="${noHousehold}">
        (function () {
            // Read server-rendered items from hidden elements (select any descendant div with data-kind)
            const items = [];
            document.querySelectorAll('#serverData div[data-kind]').forEach(div => {
                const id = div.dataset.id;
                const title = div.dataset.title;
                const start = div.dataset.start;
                const end = div.dataset.end;
                const allDay = div.dataset.allday === 'true' || div.dataset.allday === 'True';
                const kind = div.dataset.kind;
                items.push({ id, title, start, end, allDay, kind });
            });

            //normalize to map by date string YYYY-MM-DD
            function toDateKey(iso) {
                if (!iso) return null;
                //If time present keep local date part (try to avoid timezone shifts)
                const d = iso.split('T')[0];
                return d;
            }

            //Group items by start date (simple approach)
            function groupItemsByDate(list) {
                const map = new Map();
                list.forEach(it => {
                    const key = toDateKey(it.start);
                    if (!key) return;
                    if (!map.has(key)) map.set(key, []);
                    map.get(key).push(it);
                });
                return map;
            }

            const grouped = groupItemsByDate(items);

            //Calendar state
            let viewDate = new Date();
            viewDate.setDate(1); //normalize to first of month

            const monthLabel = document.getElementById('monthLabel');
            const calendarBody = document.getElementById('calendarBody');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            function render() {
                const year = viewDate.getFullYear();
                const month = viewDate.getMonth();
                const firstDay = new Date(year, month, 1);
                const startWeekDay = firstDay.getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                //compute previous month trailing days
                const prevMonthDays = startWeekDay;
                monthLabel.textContent = viewDate.toLocaleString(undefined, { month: 'long', year: 'numeric' });

                calendarBody.innerHTML = '';
                let dayCounter = 1;
                let nextMonthDay = 1;

                for (let week = 0; week < 6; week++) {
                    const tr = document.createElement('tr');
                    for (let dow = 0; dow < 7; dow++) {
                        const td = document.createElement('td');
                        td.className = 'align-top p-2';

                        const cellIndex = week * 7 + dow;
                        const inCurrentMonth = cellIndex >= prevMonthDays && dayCounter <= daysInMonth;

                        const cellDiv = document.createElement('div');
                        cellDiv.className = 'day' + (inCurrentMonth ? '' : ' out-of-month');

                        let cellDate;
                        if (inCurrentMonth) {
                            cellDate = new Date(year, month, dayCounter);
                            const dateNum = document.createElement('div');
                            dateNum.className = 'date-num';
                            const createLink = document.createElement('a');
                            createLink.href = `/calendar/new?date=${formatDateISO(cellDate)}`;
                            createLink.className = 'text-decoration-none';
                            createLink.textContent = dayCounter;
                            dateNum.appendChild(createLink);
                            cellDiv.appendChild(dateNum);

                            //attach items for this date
                            const key = formatDateISO(cellDate);
                            const list = grouped.get(key) || [];
                            const maxShown = 3;
                            list.slice(0, maxShown).forEach(it => {
                                const a = document.createElement('a');
                                a.className = 'badge bg-info text-truncate item-badge';
                                a.title = it.title;
                                //link to event or calendar item view/edit
                                if (it.kind === 'event') {
                                    a.href = `/events/${it.id}`;
                                } else {
                                    a.href = `/calendar/${it.id}`;
                                }
                                a.textContent = it.title;
                                cellDiv.appendChild(a);
                            });
                            if (list.length > maxShown) {
                                const more = document.createElement('div');
                                more.className = 'more';
                                const remaining = list.length - maxShown;
                                const mLink = document.createElement('a');
                                mLink.href = `/calendar?date=${key}`;
                                mLink.textContent = `+${remaining} more`;
                                more.appendChild(mLink);
                                cellDiv.appendChild(more);
                            }

                            dayCounter++;
                        } else {
                            //show previous or next month dates as muted
                            let displayNum;
                            if (cellIndex < prevMonthDays) {
                                //previous month day number
                                const prevMonthLastDay = new Date(year, month, 0).getDate();
                                displayNum = prevMonthLastDay - (prevMonthDays - 1) + cellIndex;
                            } else {
                                //next month
                                displayNum = nextMonthDay++;
                            }
                            const span = document.createElement('div');
                            span.className = 'date-num';
                            span.textContent = displayNum;
                            cellDiv.appendChild(span);
                        }

                        td.appendChild(cellDiv);
                        tr.appendChild(td);
                    }
                    calendarBody.appendChild(tr);
                }
            }

            function formatDateISO(d) {
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${y}-${m}-${day}`;
            }

            prevBtn.addEventListener('click', () => {
                viewDate.setMonth(viewDate.getMonth() - 1);
                render();
            });

            nextBtn.addEventListener('click', () => {
                viewDate.setMonth(viewDate.getMonth() + 1);
                render();
            });
            render();
        })();
    </script>
</body>

</html>