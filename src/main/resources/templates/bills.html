<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoomieRadar | Bills</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>

<body class="bg-light d-flex flex-column min-vh-100">

    <header class="bg-primary text-white text-center py-4 shadow-sm">
        <h1 class="fs-3 mb-1 fw-bold">RoomieRadar</h1>
        <p class="mb-0 small opacity-90">Bills Management</p>
    </header>

    <main class="container my-4 flex-grow-1">
        <div th:if="${noHousehold}" class="alert alert-warning">You must join or create a household to manage bills.
        </div>
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>Outstanding Bills</h2>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#billModal"
                th:disabled="${noHousehold}">Add Bill</button>
        </div>

        <div th:if="${noHousehold}" class="text-muted text-center py-5">
            <i class="bi bi-house-slash display-1 text-secondary opacity-25"></i>
            <p class="mt-3">Bill list hidden until household membership is established.</p>
        </div>

        <div th:unless="${noHousehold}">
            <div th:if="${bills.isEmpty()}" class="text-center text-muted py-5">
                <i class="bi bi-receipt display-1 opacity-25"></i>
                <p class="mt-3">No bills yet. Add your first bill to get started!</p>
            </div>
            <div class="list-group shadow-sm rounded-3 overflow-hidden" th:unless="${bills.isEmpty()}">
                <div th:each="bill : ${bills}" class="list-group-item p-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="fw-bold fs-5" th:text="${bill.name}">Bill Name</div>
                            <small class="text-muted" th:if="${bill.dueDate}"
                                th:text="'Due: ' + ${#temporals.format(bill.dueDate, 'MMM dd, yyyy')}">Due Date</small>
                            <small class="text-muted d-block" th:if="${bill.description}"
                                th:text="${bill.description}">Description</small>
                            <div class="mt-2">
                                <span class="badge bg-info me-2">
                                    Total: $<span th:text="${#numbers.formatDecimal(bill.amount, 1, 2)}">0.00</span>
                                </span>
                                <div class="mt-2">
                                    <div th:each="split : ${bill.splits}"
                                        class="d-flex align-items-center justify-content-between mb-1 p-1 border rounded bg-white">
                                        <span>
                                            <i class="bi bi-person-circle text-secondary me-1"></i>
                                            <span th:text="${split.user.username}" class="fw-medium">User</span>:
                                            $<span
                                                th:text="${#numbers.formatDecimal(split.splitAmount, 1, 2)}">0.00</span>
                                        </span>

                                        <div class="d-flex align-items-center">
                                            <!-- Status Badges -->
                                            <span th:if="${split.status.name() == 'PAID'}"
                                                class="badge bg-success rounded-pill">Paid</span>
                                            <span th:if="${split.status.name() == 'PENDING_APPROVAL'}"
                                                class="badge bg-warning text-dark rounded-pill">Pending</span>
                                            <span th:if="${split.status.name() == 'UNPAID'}"
                                                class="badge bg-danger rounded-pill">Unpaid</span>

                                            <!-- Actions -->
                                            <!-- Settle Button (Visible to Debtor if UNPAID) -->
                                            <button
                                                th:if="${split.user.id == currentUserId and split.status.name() == 'UNPAID'}"
                                                class="btn btn-sm btn-primary ms-2 py-0 px-2" style="font-size: 0.8rem;"
                                                th:onclick="'settleSplit(' + ${split.id} + ')'">
                                                Settle
                                            </button>

                                            <!-- Approve Button (Visible to Creator if PENDING_APPROVAL) -->
                                            <button
                                                th:if="${bill.createdBy.id == currentUserId and split.status.name() == 'PENDING_APPROVAL'}"
                                                class="btn btn-sm btn-success ms-2 py-0 px-2" style="font-size: 0.8rem;"
                                                th:onclick="'approveSplit(' + ${split.id} + ')'">
                                                Approve
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-danger" th:data-bill-id="${bill.id}"
                            onclick="deleteBill(this.getAttribute('data-bill-id'))">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div th:replace="~{fragments/modals :: modals}"></div>

    <nav class="navbar fixed-bottom navbar-bottom shadow-lg">
        <div class="container d-flex justify-content-around">
            <a th:href="@{/}" class="nav-link" title="Home">
                <i class="bi bi-house-door-fill fs-4"></i>
                <span class="d-none d-sm-inline ms-1">Home</span>
            </a>
            <a th:href="@{/bills}" class="nav-link active" title="Bills">
                <i class="bi bi-cash-stack fs-4"></i>
                <span class="d-none d-sm-inline ms-1">Bills</span>
            </a>
            <a th:href="@{/chores}" class="nav-link" title="Chores">
                <i class="bi bi-broom fs-4"></i>
                <span class="d-none d-sm-inline ms-1">Chores</span>
            </a>
            <a th:href="@{/events}" class="nav-link" title="Events">
                <i class="bi bi-calendar-event fs-4"></i>
                <span class="d-none d-sm-inline ms-1">Events</span>
            </a>
            <a th:href="@{/calendar}" class="nav-link" title="Calendar">
                <i class="bi bi-calendar-week fs-4"></i>
                <span class="d-none d-sm-inline ms-1">Calendar</span>
            </a>
            <a th:href="@{/household}" class="nav-link" title="Household">
                <i class="bi bi-people-fill fs-4"></i>
                <span class="d-none d-sm-inline ms-1">People</span>
            </a>
            <form id="logoutForm" th:action="@{/logout}" method="post" style="display: none;"></form>
            <a href="#" onclick="document.getElementById('logoutForm').submit(); return false;"
                class="nav-link text-danger" title="Logout">
                <i class="bi bi-box-arrow-right fs-4"></i>
                <span class="d-none d-sm-inline ms-1">Logout</span>
            </a>
        </div>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/script.js}"></script>
    <script th:inline="javascript">
        // Pass household users data to JavaScript as a real JS array
        const householdUsers = /*[[${householdUsers}]]*/[];

        document.addEventListener('DOMContentLoaded', function () {
            console.log('bills.html inline script loaded');

            // CSRF Token
            const csrfToken = document.querySelector("meta[name='_csrf']").getAttribute("content");
            const csrfHeader = document.querySelector("meta[name='_csrf_header']").getAttribute("content");

            // Populate user checkboxes when modal opens
            const billModalEl = document.getElementById('billModal');
            if (billModalEl) {
                billModalEl.addEventListener('show.bs.modal', function () {
                    const userCheckboxesDiv = document.getElementById('userCheckboxes');
                    if (userCheckboxesDiv && Array.isArray(householdUsers) && householdUsers.length > 0) {
                        userCheckboxesDiv.innerHTML = '';
                        householdUsers.forEach(function (user) {
                            const div = document.createElement('div');
                            div.className = 'form-check';
                            div.innerHTML =
                                '<input class="form-check-input" type="checkbox" value="' + user.id + '" id="user-' + user.id + '">' +
                                '<label class="form-check-label" for="user-' + user.id + '">' +
                                user.username +
                                '</label>';
                            userCheckboxesDiv.appendChild(div);
                        });
                    }
                });
            }

            // Handle split equally toggle
            const splitEquallyCheckbox = document.getElementById('splitEqually');
            const userSelectionDiv = document.getElementById('userSelectionDiv');
            if (splitEquallyCheckbox && userSelectionDiv) {
                userSelectionDiv.style.display = splitEquallyCheckbox.checked ? 'none' : 'block';
                splitEquallyCheckbox.addEventListener('change', function () {
                    userSelectionDiv.style.display = splitEquallyCheckbox.checked ? 'none' : 'block';
                });
            }

            // Bill modal submit handler
            const billModalSubmit = document.getElementById('billModalSubmit');
            if (billModalSubmit) {
                console.log('Attaching click handler to billModalSubmit');
                billModalSubmit.addEventListener('click', function (e) {
                    e.preventDefault();
                    console.log('billModalSubmit clicked');

                    const form = document.getElementById('billModalForm');
                    if (!form) {
                        alert('Error: Form not found');
                        return;
                    }

                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return;
                    }

                    const name = document.getElementById('billName').value;
                    const amount = document.getElementById('billAmount').value;
                    const dueDate = document.getElementById('billDueDate').value;
                    const description = document.getElementById('billDescription').value;
                    const splitEqually = document.getElementById('splitEqually').checked;

                    const userIds = [];
                    if (!splitEqually) {
                        const checkboxes = document.querySelectorAll('#userCheckboxes input[type="checkbox"]:checked');
                        checkboxes.forEach(function (cb) { userIds.push(cb.value); });
                        if (userIds.length === 0) {
                            alert('Please select at least one person to split the bill with');
                            return;
                        }
                    }

                    billModalSubmit.disabled = true;
                    billModalSubmit.textContent = 'Adding...';

                    const formData = new URLSearchParams();
                    formData.append('name', name);
                    formData.append('amount', amount);
                    if (dueDate) formData.append('dueDate', dueDate);
                    if (description) formData.append('description', description);
                    formData.append('splitEqually', splitEqually);
                    userIds.forEach(function (id) { formData.append('userIds', id); });

                    console.log('Sending POST /bills/add with', formData.toString());

                    fetch('/bills/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            [csrfHeader]: csrfToken
                        },
                        body: formData.toString(),
                    })
                        .then(function (response) { return response.text(); })
                        .then(function (data) {
                            console.log('Response from /bills/add:', data);
                            if (data === 'success') {
                                location.reload();
                            } else {
                                alert('Error adding bill: ' + data);
                                billModalSubmit.disabled = false;
                                billModalSubmit.textContent = 'Add Bill';
                            }
                        })
                        .catch(function (error) {
                            console.error('Error:', error);
                            alert('An error occurred while adding the bill: ' + error.message);
                            billModalSubmit.disabled = false;
                            billModalSubmit.textContent = 'Add Bill';
                        });
                });
            } else {
                console.error('Bill modal submit button not found');
            }
        });

        // Delete bill function stays the same
        function deleteBill(billId) {
            if (confirm('Are you sure you want to delete this bill?')) {
                const csrfToken = document.querySelector("meta[name='_csrf']").getAttribute("content");
                const csrfHeader = document.querySelector("meta[name='_csrf_header']").getAttribute("content");

                fetch('/bills/' + billId, {
                    method: 'DELETE',
                    headers: {
                        [csrfHeader]: csrfToken
                    }
                })
                    .then(function (response) { return response.text(); })
                    .then(function (data) {
                        if (data === 'success') {
                            location.reload();
                        } else {
                            alert('Error deleting bill: ' + data);
                        }
                    })
                    .catch(function (error) {
                        console.error('Error:', error);
                        alert('An error occurred while deleting the bill');
                    });
            }
        }

        function settleSplit(splitId) {
            if (confirm('Mark this bill as paid? The bill creator will need to approve it.')) {
                const csrfToken = document.querySelector("meta[name='_csrf']").getAttribute("content");
                const csrfHeader = document.querySelector("meta[name='_csrf_header']").getAttribute("content");

                fetch('/bills/settle/' + splitId, {
                    method: 'POST',
                    headers: {
                        [csrfHeader]: csrfToken
                    }
                })
                    .then(function (response) { return response.text(); })
                    .then(function (data) {
                        if (data === 'success') {
                            location.reload();
                        } else {
                            alert('Error settling bill: ' + data);
                        }
                    })
                    .catch(function (error) {
                        console.error('Error:', error);
                        alert('An error occurred');
                    });
            }
        }

        function approveSplit(splitId) {
            if (confirm('Confirm that you have received payment?')) {
                const csrfToken = document.querySelector("meta[name='_csrf']").getAttribute("content");
                const csrfHeader = document.querySelector("meta[name='_csrf_header']").getAttribute("content");

                fetch('/bills/approve/' + splitId, {
                    method: 'POST',
                    headers: {
                        [csrfHeader]: csrfToken
                    }
                })
                    .then(function (response) { return response.text(); })
                    .then(function (data) {
                        if (data === 'success') {
                            location.reload();
                        } else {
                            alert('Error approving bill: ' + data);
                        }
                    })
                    .catch(function (error) {
                        console.error('Error:', error);
                        alert('An error occurred');
                    });
            }
        }
    </script>
</body>

</html>